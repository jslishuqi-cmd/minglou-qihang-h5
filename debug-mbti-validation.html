<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI ç­”é¢˜æ•°æ®éªŒè¯å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 4px; }
        .success { color: #27ae60; background: #f0f9f0; padding: 10px; border-radius: 4px; }
        .warning { color: #f39c12; background: #fef9e7; padding: 10px; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2980b9; }
        textarea { width: 100%; height: 200px; margin: 10px 0; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; }
        .dimension-detail { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” MBTI ç­”é¢˜æ•°æ®éªŒè¯å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“Š ä» Supabase åŠ è½½æ•°æ®</h3>
            <button onclick="loadFromSupabase()">åŠ è½½äº‘ç«¯æ•°æ®</button>
            <div id="supabase-status"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ æ‰‹åŠ¨è¾“å…¥ç­”é¢˜æ•°æ®</h3>
            <p>è¯·ç²˜è´´ MBTI ç­”é¢˜æ•°ç»„ï¼ˆJSON æ ¼å¼ï¼‰ï¼š</p>
            <textarea id="manual-input" placeholder='ä¾‹å¦‚ï¼š["A","B","A","B",...]'></textarea>
            <button onclick="validateManualInput()">éªŒè¯æ•°æ®</button>
        </div>

        <div class="section">
            <h3>ğŸ§ª ç”Ÿæˆå®Œæ•´æµ‹è¯•æ•°æ®</h3>
            <button onclick="generateFullTestData()">ç”Ÿæˆ 100 é¢˜å®Œæ•´æ•°æ®</button>
            <button onclick="generateIncompleteData()">ç”Ÿæˆä¸å®Œæ•´æ•°æ®ï¼ˆæ¨¡æ‹Ÿé—®é¢˜ï¼‰</button>
        </div>

        <div class="section" id="validation-results" style="display: none;">
            <h3>âœ… éªŒè¯ç»“æœ</h3>
            <div id="validation-content"></div>
        </div>

        <div class="section" id="dimension-analysis" style="display: none;">
            <h3>ğŸ“ˆ ç»´åº¦åˆ†æ</h3>
            <div id="dimension-content"></div>
        </div>
    </div>

    <!-- Supabase åˆå§‹åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        function validateMBTIData(answers) {
            const results = {
                isValid: true,
                totalAnswers: answers ? answers.length : 0,
                validAnswers: 0,
                invalidAnswers: [],
                dimensionCounts: { EI: 0, SN: 0, TF: 0, JP: 0 },
                scores: { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 },
                issues: []
            };

            if (!answers || !Array.isArray(answers)) {
                results.isValid = false;
                results.issues.push('ç­”é¢˜æ•°æ®ä¸æ˜¯æœ‰æ•ˆæ•°ç»„');
                return results;
            }

            if (answers.length !== 100) {
                results.isValid = false;
                results.issues.push(`ç­”é¢˜æ•°é‡ä¸æ­£ç¡®ï¼šæœŸæœ› 100 é¢˜ï¼Œå®é™… ${answers.length} é¢˜`);
            }

            answers.forEach((answer, index) => {
                if (!answer || (answer !== 'A' && answer !== 'B')) {
                    results.invalidAnswers.push({ 
                        questionNumber: index + 1, 
                        answer: answer,
                        expected: 'A æˆ– B'
                    });
                    return;
                }

                results.validAnswers++;

                // æŒ‰ç»´åº¦åˆ†ç±»ç»Ÿè®¡
                if (index < 25) {
                    // ç¬¬1-25é¢˜ï¼šE vs I
                    results.dimensionCounts.EI++;
                    if (answer === 'A') results.scores.E++;
                    else results.scores.I++;
                } else if (index < 50) {
                    // ç¬¬26-50é¢˜ï¼šS vs N
                    results.dimensionCounts.SN++;
                    if (answer === 'A') results.scores.S++;
                    else results.scores.N++;
                } else if (index < 75) {
                    // ç¬¬51-75é¢˜ï¼šT vs F
                    results.dimensionCounts.TF++;
                    if (answer === 'A') results.scores.T++;
                    else results.scores.F++;
                } else if (index < 100) {
                    // ç¬¬76-100é¢˜ï¼šJ vs P
                    results.dimensionCounts.JP++;
                    if (answer === 'A') results.scores.J++;
                    else results.scores.P++;
                }
            });

            // æ£€æŸ¥æ¯ä¸ªç»´åº¦æ˜¯å¦æœ‰ 25 é¢˜
            Object.entries(results.dimensionCounts).forEach(([dimension, count]) => {
                if (count !== 25) {
                    results.isValid = false;
                    results.issues.push(`${dimension} ç»´åº¦é¢˜ç›®æ•°ä¸æ­£ç¡®ï¼šæœŸæœ› 25 é¢˜ï¼Œå®é™… ${count} é¢˜`);
                }
            });

            if (results.invalidAnswers.length > 0) {
                results.isValid = false;
                results.issues.push(`å‘ç° ${results.invalidAnswers.length} ä¸ªæ— æ•ˆç­”æ¡ˆ`);
            }

            return results;
        }

        function displayValidationResults(results) {
            const container = document.getElementById('validation-content');
            const dimensionContainer = document.getElementById('dimension-content');
            
            let html = '';
            
            // æ€»ä½“çŠ¶æ€
            if (results.isValid) {
                html += '<div class="success">âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼æ‰€æœ‰ 100 é¢˜ç­”é¢˜å®Œæ•´ä¸”æœ‰æ•ˆã€‚</div>';
            } else {
                html += '<div class="error">âŒ æ•°æ®éªŒè¯å¤±è´¥ï¼å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š</div>';
                html += '<ul>';
                results.issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul>';
            }

            // ç»Ÿè®¡ä¿¡æ¯
            html += '<div class="stats">';
            html += `<div class="stat-card"><strong>${results.totalAnswers}</strong><br>æ€»é¢˜æ•°</div>`;
            html += `<div class="stat-card"><strong>${results.validAnswers}</strong><br>æœ‰æ•ˆç­”æ¡ˆ</div>`;
            html += `<div class="stat-card"><strong>${results.invalidAnswers.length}</strong><br>æ— æ•ˆç­”æ¡ˆ</div>`;
            html += `<div class="stat-card"><strong>${results.isValid ? 'é€šè¿‡' : 'å¤±è´¥'}</strong><br>éªŒè¯çŠ¶æ€</div>`;
            html += '</div>';

            // æ— æ•ˆç­”æ¡ˆè¯¦æƒ…
            if (results.invalidAnswers.length > 0) {
                html += '<div class="warning"><strong>æ— æ•ˆç­”æ¡ˆè¯¦æƒ…ï¼š</strong><br>';
                results.invalidAnswers.slice(0, 10).forEach(invalid => {
                    html += `ç¬¬ ${invalid.questionNumber} é¢˜ï¼šç­”æ¡ˆ "${invalid.answer}"ï¼ŒæœŸæœ› "${invalid.expected}"<br>`;
                });
                if (results.invalidAnswers.length > 10) {
                    html += `... è¿˜æœ‰ ${results.invalidAnswers.length - 10} ä¸ªæ— æ•ˆç­”æ¡ˆ`;
                }
                html += '</div>';
            }

            container.innerHTML = html;
            document.getElementById('validation-results').style.display = 'block';

            // ç»´åº¦åˆ†æ
            let dimensionHtml = '<div class="stats">';
            Object.entries(results.dimensionCounts).forEach(([dimension, count]) => {
                const isCorrect = count === 25;
                const cardClass = isCorrect ? 'success' : 'error';
                dimensionHtml += `<div class="stat-card" style="background: ${isCorrect ? '#f0f9f0' : '#fdf2f2'};">`;
                dimensionHtml += `<strong>${dimension}</strong><br>${count}/25 é¢˜<br>`;
                dimensionHtml += `${isCorrect ? 'âœ…' : 'âŒ'}`;
                dimensionHtml += '</div>';
            });
            dimensionHtml += '</div>';

            // å¾—åˆ†åˆ†å¸ƒ
            dimensionHtml += '<h4>å¾—åˆ†åˆ†å¸ƒï¼š</h4>';
            const dimensions = [
                { name: 'å¤–å‘(E) vs å†…å‘(I)', left: 'E', right: 'I' },
                { name: 'æ„Ÿè§‰(S) vs ç›´è§‰(N)', left: 'S', right: 'N' },
                { name: 'æ€è€ƒ(T) vs æƒ…æ„Ÿ(F)', left: 'T', right: 'F' },
                { name: 'åˆ¤æ–­(J) vs çŸ¥è§‰(P)', left: 'J', right: 'P' }
            ];

            dimensions.forEach(dim => {
                const leftScore = results.scores[dim.left] || 0;
                const rightScore = results.scores[dim.right] || 0;
                const total = leftScore + rightScore;
                
                dimensionHtml += '<div class="dimension-detail">';
                dimensionHtml += `<strong>${dim.name}</strong><br>`;
                dimensionHtml += `${dim.left}: ${leftScore} é¢˜ï¼Œ${dim.right}: ${rightScore} é¢˜ï¼Œæ€»è®¡: ${total} é¢˜`;
                if (total !== 25) {
                    dimensionHtml += ` <span style="color: #e74c3c;">âš ï¸ åº”ä¸º 25 é¢˜</span>`;
                }
                dimensionHtml += '</div>';
            });

            dimensionContainer.innerHTML = dimensionHtml;
            document.getElementById('dimension-analysis').style.display = 'block';
        }

        async function loadFromSupabase() {
            const statusDiv = document.getElementById('supabase-status');
            
            try {
                if (!window.supabaseClient) {
                    statusDiv.innerHTML = '<div class="error">Supabase æœªåˆå§‹åŒ–</div>';
                    return;
                }

                statusDiv.innerHTML = '<div class="warning">æ­£åœ¨åŠ è½½æ•°æ®...</div>';

                const { data, error } = await window.supabaseClient
                    .from('test_results')
                    .select('name, mbti_answers, timestamp')
                    .order('timestamp', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data.length === 0) {
                    statusDiv.innerHTML = '<div class="warning">æœªæ‰¾åˆ°æµ‹è¯•æ•°æ®</div>';
                    return;
                }

                let html = '<div class="success">æˆåŠŸåŠ è½½æ•°æ®</div>';
                html += '<h4>æœ€è¿‘ 10 æ¡è®°å½•ï¼š</h4>';
                
                data.forEach((record, index) => {
                    const answers = record.mbti_answers || [];
                    const results = validateMBTIData(answers);
                    const statusIcon = results.isValid ? 'âœ…' : 'âŒ';
                    
                    html += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
                    html += `<strong>${record.name}</strong> ${statusIcon} `;
                    html += `(${answers.length} é¢˜, ${results.validAnswers} æœ‰æ•ˆ)`;
                    html += ` <button onclick="validateSpecificRecord(${index}, '${record.name}', ${JSON.stringify(answers).replace(/"/g, '&quot;')})">è¯¦ç»†åˆ†æ</button>`;
                    html += '</div>';
                });

                statusDiv.innerHTML = html;

            } catch (error) {
                statusDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        function validateSpecificRecord(index, name, answers) {
            const results = validateMBTIData(answers);
            displayValidationResults(results);
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('validation-results').querySelector('h3').textContent = `âœ… ${name} çš„éªŒè¯ç»“æœ`;
        }

        function validateManualInput() {
            const input = document.getElementById('manual-input').value.trim();
            
            try {
                const answers = JSON.parse(input);
                const results = validateMBTIData(answers);
                displayValidationResults(results);
            } catch (error) {
                document.getElementById('validation-content').innerHTML = 
                    `<div class="error">JSON è§£æå¤±è´¥ï¼š${error.message}</div>`;
                document.getElementById('validation-results').style.display = 'block';
            }
        }

        function generateFullTestData() {
            // ç”Ÿæˆå®Œæ•´çš„ 100 é¢˜æ•°æ®
            const answers = [];
            for (let i = 0; i < 100; i++) {
                answers.push(Math.random() > 0.5 ? 'A' : 'B');
            }
            
            document.getElementById('manual-input').value = JSON.stringify(answers);
            
            const results = validateMBTIData(answers);
            displayValidationResults(results);
        }

        function generateIncompleteData() {
            // ç”Ÿæˆä¸å®Œæ•´æ•°æ®æ¥æ¨¡æ‹Ÿé—®é¢˜
            const answers = [];
            
            // EI ç»´åº¦ï¼šåªæœ‰ 24 é¢˜
            for (let i = 0; i < 24; i++) {
                answers.push(Math.random() > 0.5 ? 'A' : 'B');
            }
            
            // SN ç»´åº¦ï¼š25 é¢˜
            for (let i = 0; i < 25; i++) {
                answers.push(Math.random() > 0.5 ? 'A' : 'B');
            }
            
            // TF ç»´åº¦ï¼š25 é¢˜
            for (let i = 0; i < 25; i++) {
                answers.push(Math.random() > 0.5 ? 'A' : 'B');
            }
            
            // JP ç»´åº¦ï¼šåªæœ‰ 21 é¢˜
            for (let i = 0; i < 21; i++) {
                answers.push(Math.random() > 0.5 ? 'A' : 'B');
            }
            
            // æ·»åŠ ä¸€äº›æ— æ•ˆç­”æ¡ˆ
            answers[10] = null;
            answers[30] = '';
            answers[50] = 'C';
            
            document.getElementById('manual-input').value = JSON.stringify(answers);
            
            const results = validateMBTIData(answers);
            displayValidationResults(results);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Supabase çŠ¶æ€
        window.addEventListener('load', () => {
            const statusDiv = document.getElementById('supabase-status');
            if (window.supabaseClient) {
                statusDiv.innerHTML = '<div class="success">Supabase å·²è¿æ¥ï¼Œå¯ä»¥åŠ è½½æ•°æ®</div>';
            } else {
                statusDiv.innerHTML = '<div class="error">Supabase æœªè¿æ¥</div>';
            }
        });
    </script>
</body>
</html>