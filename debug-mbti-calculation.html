<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MBTI è®¡åˆ†è°ƒè¯•å·¥å…·</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .debug-section { background: #f8fafc; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
    .error { border-left-color: #ef4444; background: #fef2f2; }
    .success { border-left-color: #10b981; background: #f0fdf4; }
    .warning { border-left-color: #f59e0b; background: #fffbeb; }
    pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; }
    button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
    button:hover { background: #2563eb; }
    .score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0; }
    .score-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
    .score-bar { background: #e2e8f0; height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden; }
    .score-fill { background: #3b82f6; height: 100%; transition: width 0.3s ease; }
  </style>
</head>
<body>
  <h1>ğŸ” MBTI è®¡åˆ†è°ƒè¯•å·¥å…·</h1>
  
  <div class="debug-section">
    <h3>ğŸ“Š é—®é¢˜è¯Šæ–­</h3>
    <p>å½“å‰å‘ç°çš„é—®é¢˜ï¼šMBTI å„ç»´åº¦å¾—åˆ†ç›¸åŠ ä¸ç­‰äº 25 é¢˜</p>
    <ul>
      <li>E: 24é¢˜ + I: 0é¢˜ = 24é¢˜ â‰  25é¢˜</li>
      <li>S: 24é¢˜ + N: 0é¢˜ = 24é¢˜ â‰  25é¢˜</li>
      <li>T: 24é¢˜ + F: 0é¢˜ = 24é¢˜ â‰  25é¢˜</li>
      <li>J: 20é¢˜ + P: 1é¢˜ = 21é¢˜ â‰  25é¢˜</li>
    </ul>
  </div>

  <div class="debug-section">
    <h3>ğŸ› ï¸ æµ‹è¯•å·¥å…·</h3>
    <button onclick="testLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®</button>
    <button onclick="testSupabaseData()">æ£€æŸ¥ Supabase æ•°æ®</button>
    <button onclick="testCalculation()">æµ‹è¯•è®¡ç®—é€»è¾‘</button>
    <button onclick="generateTestData()">ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
  </div>

  <div id="results"></div>

  <script>
    // å¼•å…¥ Supabaseï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (typeof supabase !== 'undefined') {
      const SUPABASE_URL = 'https://axziyvmsdtdcmevcpksd.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4eml5dm1zZHRkY21ldmNwa3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MDYyMjAsImV4cCI6MjA3NDI4MjIyMH0.liuWP6Ouc05-K2GCOali-zMk9TKg6h9_abS1-1_LH8Q';
      window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `debug-section ${type}`;
      div.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
      results.appendChild(div);
    }

    function calculateMBTIScores(answers) {
      const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
      
      if (!answers || !Array.isArray(answers)) {
        log(`MBTIç­”é¢˜æ•°æ®æ— æ•ˆ: ${answers}`, 'error');
        return scores;
      }
      
      log(`MBTIç­”é¢˜æ•°æ®é•¿åº¦: ${answers.length}`, 'info');
      log(`å‰20ä¸ªç­”æ¡ˆ: ${JSON.stringify(answers.slice(0, 20))}`, 'info');
      
      const validAnswers = answers.filter(a => a === 'A' || a === 'B');
      log(`æœ‰æ•ˆç­”æ¡ˆæ•°é‡: ${validAnswers.length}`, validAnswers.length === 100 ? 'success' : 'warning');
      
      answers.forEach((answer, index) => {
        if (!answer || (answer !== 'A' && answer !== 'B')) {
          return;
        }
        
        if (index < 25) {
          scores[answer === 'A' ? 'E' : 'I']++;
        } else if (index < 50) {
          scores[answer === 'A' ? 'S' : 'N']++;
        } else if (index < 75) {
          scores[answer === 'A' ? 'T' : 'F']++;
        } else if (index < 100) {
          scores[answer === 'A' ? 'J' : 'P']++;
        }
      });
      
      return scores;
    }

    function displayScores(scores, title) {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = 'debug-section';
      
      const dimensions = [
        { left: 'E', right: 'I', name: 'å¤–å‘ vs å†…å‘' },
        { left: 'S', right: 'N', name: 'æ„Ÿè§‰ vs ç›´è§‰' },
        { left: 'T', right: 'F', name: 'æ€è€ƒ vs æƒ…æ„Ÿ' },
        { left: 'J', right: 'P', name: 'åˆ¤æ–­ vs çŸ¥è§‰' }
      ];
      
      let html = `<h3>${title}</h3><div class="score-grid">`;
      
      dimensions.forEach(dim => {
        const leftScore = scores[dim.left] || 0;
        const rightScore = scores[dim.right] || 0;
        const total = leftScore + rightScore;
        const leftPercent = total > 0 ? Math.round((leftScore / total) * 100) : 50;
        
        html += `
          <div class="score-card">
            <h4>${dim.name}</h4>
            <div>${dim.left}: ${leftScore}é¢˜ | ${dim.right}: ${rightScore}é¢˜</div>
            <div>æ€»è®¡: ${total}é¢˜</div>
            <div class="score-bar">
              <div class="score-fill" style="width: ${leftPercent}%"></div>
            </div>
            <div style="color: ${total === 25 ? '#10b981' : '#ef4444'};">
              ${total === 25 ? 'âœ… æ­£ç¡®' : 'âŒ å¼‚å¸¸'}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      div.innerHTML = html;
      results.appendChild(div);
    }

    async function testLocalStorage() {
      log('ğŸ” æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®...', 'info');
      try {
        const data = JSON.parse(localStorage.getItem('testResults') || '[]');
        log(`æœ¬åœ°å­˜å‚¨è®°å½•æ•°: ${data.length}`, 'info');
        
        if (data.length > 0) {
          const latest = data[data.length - 1];
          log('æœ€æ–°è®°å½•:', 'info');
          log(latest, 'info');
          
          // æ£€æŸ¥å­—æ®µå
          const mbtiAnswers = latest.mbti_answers || latest.mbtiAnswers;
          if (mbtiAnswers) {
            const scores = calculateMBTIScores(mbtiAnswers);
            displayScores(scores, 'æœ¬åœ°å­˜å‚¨æ•°æ®è®¡ç®—ç»“æœ');
          } else {
            log('æœªæ‰¾åˆ° MBTI ç­”é¢˜æ•°æ®', 'error');
          }
        }
      } catch (e) {
        log(`æœ¬åœ°å­˜å‚¨è¯»å–å¤±è´¥: ${e.message}`, 'error');
      }
    }

    async function testSupabaseData() {
      log('ğŸ” æ£€æŸ¥ Supabase æ•°æ®...', 'info');
      try {
        if (!window.supabaseClient) {
          log('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
          return;
        }
        
        const { data, error } = await window.supabaseClient
          .from('test_results')
          .select('name,mbti_answers')
          .order('timestamp', { ascending: false })
          .limit(1);
          
        if (error) throw error;
        
        if (data && data.length > 0) {
          const latest = data[0];
          log('Supabase æœ€æ–°è®°å½•:', 'info');
          log(latest, 'info');
          
          if (latest.mbti_answers) {
            const scores = calculateMBTIScores(latest.mbti_answers);
            displayScores(scores, 'Supabase æ•°æ®è®¡ç®—ç»“æœ');
          } else {
            log('æœªæ‰¾åˆ° MBTI ç­”é¢˜æ•°æ®', 'error');
          }
        } else {
          log('Supabase ä¸­æ— æ•°æ®', 'warning');
        }
      } catch (e) {
        log(`Supabase è¯»å–å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function testCalculation() {
      log('ğŸ§® æµ‹è¯•è®¡ç®—é€»è¾‘...', 'info');
      
      // ç”Ÿæˆå®Œæ•´çš„æµ‹è¯•æ•°æ®
      const testAnswers = [];
      for (let i = 0; i < 100; i++) {
        testAnswers.push(Math.random() > 0.5 ? 'A' : 'B');
      }
      
      log('ç”Ÿæˆçš„æµ‹è¯•æ•°æ®:', 'info');
      log(`é•¿åº¦: ${testAnswers.length}`, 'info');
      
      const scores = calculateMBTIScores(testAnswers);
      displayScores(scores, 'æµ‹è¯•æ•°æ®è®¡ç®—ç»“æœ');
    }

    function generateTestData() {
      log('ğŸ“ ç”Ÿæˆæ ‡å‡†æµ‹è¯•æ•°æ®...', 'info');
      
      // ç”Ÿæˆæ ‡å‡†åˆ†å¸ƒçš„æµ‹è¯•æ•°æ®
      const testAnswers = [];
      
      // E vs I: 15 vs 10
      for (let i = 0; i < 25; i++) {
        testAnswers.push(i < 15 ? 'A' : 'B');
      }
      
      // S vs N: 12 vs 13
      for (let i = 0; i < 25; i++) {
        testAnswers.push(i < 12 ? 'A' : 'B');
      }
      
      // T vs F: 18 vs 7
      for (let i = 0; i < 25; i++) {
        testAnswers.push(i < 18 ? 'A' : 'B');
      }
      
      // J vs P: 20 vs 5
      for (let i = 0; i < 25; i++) {
        testAnswers.push(i < 20 ? 'A' : 'B');
      }
      
      log('æ ‡å‡†æµ‹è¯•æ•°æ®ç”Ÿæˆå®Œæˆ:', 'success');
      log(`æ€»é•¿åº¦: ${testAnswers.length}`, 'info');
      
      const scores = calculateMBTIScores(testAnswers);
      displayScores(scores, 'æ ‡å‡†æµ‹è¯•æ•°æ®è®¡ç®—ç»“æœ');
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ç”¨äºæµ‹è¯•
      const testResult = {
        name: 'æµ‹è¯•ç”¨æˆ·',
        holland: 'ESI',
        mbti: 'ESTJ',
        timestamp: new Date().toISOString(),
        holland_answers: new Array(60).fill('A'),
        mbti_answers: testAnswers
      };
      
      try {
        const existing = JSON.parse(localStorage.getItem('testResults') || '[]');
        existing.push(testResult);
        localStorage.setItem('testResults', JSON.stringify(existing));
        log('æµ‹è¯•æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
      } catch (e) {
        log(`ä¿å­˜å¤±è´¥: ${e.message}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      log('ğŸš€ MBTI è®¡åˆ†è°ƒè¯•å·¥å…·å·²å¯åŠ¨', 'success');
      log('è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è°ƒè¯•', 'info');
    });
  </script>

  <!-- å°è¯•åŠ è½½ Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onerror="console.log('Supabase SDK åŠ è½½å¤±è´¥')"></script>
</body>
</html>