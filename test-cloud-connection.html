<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试云端连接</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .detail-btn { background: #28a745; padding: 4px 8px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🔍 云端连接测试</h1>
    
    <div id="status-container">
        <div class="status info">正在检测云端连接...</div>
    </div>
    
    <button onclick="testConnection()">测试连接</button>
    <button onclick="loadTestData()">加载测试数据</button>
    <button onclick="testDetailFunction()">测试详情功能</button>
    
    <div id="data-container"></div>
    
    <!-- 详细得分弹窗 -->
    <div id="detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:16px; max-width:700px; width:90%; max-height:80%; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="detail-title">详细得分分析</h3>
                <button onclick="closeDetailModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <div id="detail-content"></div>
        </div>
    </div>

    <!-- Supabase 初始化 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let testData = [];
        
        function updateStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function testConnection() {
            updateStatus('正在测试 Supabase 连接...', 'info');
            
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase 客户端未初始化');
                }
                
                // 测试连接
                const { data, error } = await window.supabaseClient
                    .from('test_results')
                    .select('count')
                    .limit(1);
                    
                if (error) throw error;
                
                updateStatus('✅ Supabase 连接成功！可以读取云端数据', 'success');
            } catch (e) {
                updateStatus(`❌ 连接失败: ${e.message}`, 'error');
            }
        }
        
        async function loadTestData() {
            updateStatus('正在加载云端数据...', 'info');
            
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase 客户端未初始化');
                }
                
                const { data, error } = await window.supabaseClient
                    .from('test_results')
                    .select('name,timestamp,holland,mbti,holland_answers,mbti_answers')
                    .order('timestamp', { ascending: false })
                    .limit(10);
                    
                if (error) throw error;
                
                testData = data || [];
                updateStatus(`✅ 成功加载 ${testData.length} 条记录`, 'success');
                
                // 渲染表格
                renderTestTable(testData);
                
            } catch (e) {
                updateStatus(`❌ 加载失败: ${e.message}`, 'error');
            }
        }
        
        function renderTestTable(data) {
            if (data.length === 0) {
                document.getElementById('data-container').innerHTML = '<p>暂无数据</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>完成时间</th>
                            <th>霍兰德代码</th>
                            <th>MBTI类型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach((row, index) => {
                html += `
                    <tr>
                        <td>${row.name || ''}</td>
                        <td>${formatTime(row.timestamp)}</td>
                        <td>${row.holland || ''}</td>
                        <td>${row.mbti || ''}</td>
                        <td><button class="detail-btn" onclick="showDetail(${index})">查看详情</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('data-container').innerHTML = html;
        }
        
        function formatTime(ts) {
            if (!ts) return '-';
            try {
                const d = new Date(ts);
                return d.toLocaleString('zh-CN', { hour12: false });
            } catch { return ts; }
        }
        
        function showDetail(index) {
            const user = testData[index];
            if (!user) {
                alert('未找到该用户的详细数据');
                return;
            }
            
            document.getElementById('detail-title').textContent = `${user.name} - 详细得分分析`;
            
            let content = '<div style="line-height:1.6;">';
            
            // 霍兰德详细得分
            content += '<h4 style="color:#3b82f6; margin-bottom:15px;">🎯 霍兰德职业兴趣详细得分</h4>';
            if (user.holland_answers && user.holland_answers.length > 0) {
                const hollandScores = calculateHollandScores(user.holland_answers);
                content += '<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:20px;">';
                Object.entries(hollandScores).forEach(([type, score]) => {
                    const typeNames = {
                        'R': '现实型(Realistic)',
                        'I': '研究型(Investigative)', 
                        'A': '艺术型(Artistic)',
                        'S': '社会型(Social)',
                        'E': '企业型(Enterprising)',
                        'C': '常规型(Conventional)'
                    };
                    const percentage = Math.round((score / 10) * 100);
                    content += `
                        <div style="background:#f8fafc; padding:12px; border-radius:8px; border-left:4px solid #3b82f6;">
                            <div style="font-weight:bold; color:#1e293b;">${type} - ${typeNames[type]}</div>
                            <div style="color:#64748b; font-size:14px;">${score}/10 分 (${percentage}%)</div>
                            <div style="background:#e2e8f0; height:6px; border-radius:3px; margin-top:5px;">
                                <div style="background:#3b82f6; height:100%; width:${percentage}%; border-radius:3px;"></div>
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            } else {
                content += '<p style="color:#64748b;">暂无霍兰德答题详情</p>';
            }
            
            // MBTI详细得分
            content += '<h4 style="color:#8b5cf6; margin-bottom:15px;">🧠 MBTI性格偏好详细分析</h4>';
            if (user.mbti_answers && user.mbti_answers.length > 0) {
                const mbtiScores = calculateMBTIScores(user.mbti_answers);
                content += '<div style="display:grid; grid-template-columns:1fr; gap:15px;">';
                
                const dimensions = [
                    { key: 'EI', name: '外向(E) vs 内向(I)', left: 'E', right: 'I' },
                    { key: 'SN', name: '感觉(S) vs 直觉(N)', left: 'S', right: 'N' },
                    { key: 'TF', name: '思考(T) vs 情感(F)', left: 'T', right: 'F' },
                    { key: 'JP', name: '判断(J) vs 知觉(P)', left: 'J', right: 'P' }
                ];

                dimensions.forEach(dim => {
                    const leftScore = mbtiScores[dim.left] || 0;
                    const rightScore = mbtiScores[dim.right] || 0;
                    const total = leftScore + rightScore;
                    const leftPercent = total > 0 ? Math.round((leftScore / total) * 100) : 50;
                    const rightPercent = 100 - leftPercent;
                    const dominant = leftPercent > rightPercent ? dim.left : dim.right;
                    const dominantPercent = Math.max(leftPercent, rightPercent);

                    content += `
                        <div style="background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid #8b5cf6;">
                            <div style="font-weight:bold; color:#1e293b; margin-bottom:8px;">${dim.name}</div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span style="color:#64748b;">${dim.left}: ${leftScore}题 (${leftPercent}%)</span>
                                <span style="color:#64748b;">${dim.right}: ${rightScore}题 (${rightPercent}%)</span>
                            </div>
                            <div style="display:flex; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                                <div style="background:#8b5cf6; width:${leftPercent}%;"></div>
                                <div style="background:#06b6d4; width:${rightPercent}%;"></div>
                            </div>
                            <div style="text-align:center; margin-top:8px; font-weight:bold; color:#${dominant === dim.left ? '8b5cf6' : '06b6d4'};">
                                倾向：${dominant} (${dominantPercent}%)
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            } else {
                content += '<p style="color:#64748b;">暂无MBTI答题详情</p>';
            }

            // 综合结果
            content += `
                <div style="margin-top:25px; padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; color:white;">
                    <h4 style="margin:0 0 10px 0;">📊 综合测评结果</h4>
                    <div style="display:flex; justify-content:space-around; text-align:center;">
                        <div>
                            <div style="font-size:24px; font-weight:bold;">${user.holland}</div>
                            <div style="opacity:0.9;">霍兰德代码</div>
                        </div>
                        <div style="width:1px; background:rgba(255,255,255,0.3);"></div>
                        <div>
                            <div style="font-size:24px; font-weight:bold;">${user.mbti}</div>
                            <div style="opacity:0.9;">MBTI类型</div>
                        </div>
                    </div>
                </div>
            `;

            content += '</div>';
            document.getElementById('detail-content').innerHTML = content;
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        function calculateHollandScores(answers) {
            const scores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
            const hollandMapping = [
                'R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I',
                'A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S',
                'E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C'
            ];
            
            answers.forEach((answer, index) => {
                if (answer && hollandMapping[index]) {
                    scores[hollandMapping[index]]++;
                }
            });
            
            return scores;
        }

        function calculateMBTIScores(answers) {
            const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            const mbtiMapping = [
                'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
                'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P',
                'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
                'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P',
                'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
                'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P'
            ];
            
            answers.forEach((answer, index) => {
                if (answer && mbtiMapping[index]) {
                    scores[mbtiMapping[index]]++;
                }
            });
            
            return scores;
        }
        
        function testDetailFunction() {
            if (testData.length > 0) {
                showDetail(0);
            } else {
                alert('请先加载测试数据');
            }
        }
        
        // 点击弹窗外部关闭
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                closeDetailModal();
            }
        });
        
        // 页面加载时自动测试连接
        window.onload = function() {
            setTimeout(testConnection, 1000);
        };
    </script>
</body>
</html>