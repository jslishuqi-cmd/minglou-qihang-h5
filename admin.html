<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>管理员数据看板 - 启航加油站</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .admin-grid{display:grid;grid-template-columns:1fr;gap:12px;}
    .filters{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);}
    th,td{border-bottom:1px solid var(--border);padding:8px;color:var(--text);}
    th{background:#12151b;text-align:left;}
    .count{color:var(--muted);}
  </style>
</head>
<body>
  <section class="page">
    <div class="container" id="login-section">
      <h2>管理员登录</h2>
      <div class="card">
        <label class="label">请输入管理员密码</label>
        <input id="admin-password" type="password" class="input" placeholder="输入密码"/>
        <button id="login-btn" class="btn primary" style="margin-top:12px;">登录</button>
      </div>
    </div>
    
    <div class="container" id="admin-panel" style="display:none;">
      <h2>管理员数据看板</h2>
      <p class="count">数据源优先：Supabase（若已初始化）；否则读取本地备份</p>

      <div class="card">
        <div class="filters">
          <div>
            <label class="label">姓名（模糊）</label>
            <input id="filter-name" class="input" placeholder="例如：张 / 李"/>
          </div>
          <div>
            <label class="label">霍兰德包含（如 R/I/A/S/E/C 多选）</label>
            <input id="filter-holland" class="input" placeholder="例如：S 或 RE"/>
          </div>
          <div>
            <label class="label">MBTI精确（如 INFP）</label>
            <input id="filter-mbti" class="input" placeholder="例如：INFP"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="btn-refresh" class="btn">刷新</button>
          <button id="btn-export" class="btn">导出Excel（CSV）</button>
        </div>
      </div>

      <div class="card">
        <table id="data-table">
          <thead>
          <tr>
            <th>姓名</th>
            <th>完成时间</th>
            <th>霍兰德代码</th>
            <th>MBTI代码</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Supabase 初始化：统一引用 SDK 与全局配置 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script>
    async function loadData() {
      // 优先从 Supabase 读取
      try {
        if (window.supabaseClient) {
          const { data, error } = await window.supabaseClient
            .from('test_results')
            .select('name,timestamp,holland,mbti')
            .order('timestamp', { ascending: false });
          if (error) throw error;
          console.log('从 Supabase 读取成功，条数：', data.length);
          return data.map(row => ({
            name: row.name || '',
            timestamp: row.timestamp || '',
            holland: row.holland || '',
            mbti: row.mbti || ''
          }));
        }
      } catch (e) {
        console.error('Supabase 读取失败，改用本地：', e);
      }

      // 退回本地存储备份
      try {
        const local = JSON.parse(localStorage.getItem('testResults') || '[]');
        console.log('从本地读取成功，条数：', local.length);
        return local.map(x => ({
          name: x.name || '',
          timestamp: x.timestamp || '',
          holland: x.holland || '',
          mbti: x.mbti || ''
        })).reverse();
      } catch (_) {
        return [];
      }
    }

    function applyFilters(rows) {
      const nameKey = document.getElementById('filter-name').value.trim();
      const hollandKey = document.getElementById('filter-holland').value.trim().toUpperCase();
      const mbtiKey = document.getElementById('filter-mbti').value.trim().toUpperCase();

      return rows.filter(r => {
        const byName = !nameKey || (r.name || '').includes(nameKey);
        const byHolland = !hollandKey || hollandKey.split('').every(ch => (r.holland || '').includes(ch));
        const byMBTI = !mbtiKey || (r.mbti || '').toUpperCase() === mbtiKey;
        return byName && byHolland && byMBTI;
      });
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${formatTime(r.timestamp)}</td>
          <td>${escapeHtml(r.holland)}</td>
          <td>${escapeHtml(r.mbti)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        const d = new Date(ts);
        return d.toLocaleString('zh-CN', { hour12:false });
      } catch { return ts; }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({
        '&':'&','<':'<','>':'>','"':'"',"'":'&#39;'
      }[m]));
    }

    function exportCSV(rows) {
      const header = ['姓名','完成时间','霍兰德代码','MBTI代码'];
      const lines = [header.join(',')].concat(
        rows.map(r => [r.name, formatTime(r.timestamp), r.holland, r.mbti]
          .map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      );
      const blob = new Blob([lines.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '启航加油站_测试结果.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function refresh() {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      renderTable(filtered);
    }

    // 事件
    document.getElementById('btn-refresh').addEventListener('click', refresh);
    document.getElementById('btn-export').addEventListener('click', async () => {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      exportCSV(filtered);
    });
    ['filter-name','filter-holland','filter-mbti'].forEach(id => {
      document.getElementById(id).addEventListener('input', refresh);
    });

    // 登录验证
    const ADMIN_PASSWORD = '82809988';
    document.getElementById('login-btn').addEventListener('click', () => {
      const password = document.getElementById('admin-password').value;
      if (password === ADMIN_PASSWORD) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        refresh();
      } else {
        alert('密码错误');
        document.getElementById('admin-password').value = '';
      }
    });
    
    // 回车登录
    document.getElementById('admin-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('login-btn').click();
      }
    });
  </script>
</body>
</html>