<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - "明楼"启航加油站</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        input[type="text"], select {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }
        
        .results-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            color: #dc3545;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>"明楼"启航加油站 - 管理后台</h1>
    </div>
    
    <div class="container">
        <!-- 登录表单 -->
        <div id="loginForm" class="login-form">
            <h2 style="text-align: center; margin-bottom: 20px;">管理员登录</h2>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="请输入管理员密码">
                <div id="loginError" class="error"></div>
            </div>
            <button id="loginBtn" class="btn">登录</button>
        </div>
        
        <!-- 管理面板 -->
        <div id="dashboard" class="dashboard">
            <div class="stats">
                <div class="stat-card">
                    <div id="totalCount" class="stat-number">0</div>
                    <div class="stat-label">总测试人数</div>
                </div>
                <div class="stat-card">
                    <div id="todayCount" class="stat-number">0</div>
                    <div class="stat-label">今日测试</div>
                </div>
                <div class="stat-card">
                    <div id="weekCount" class="stat-number">0</div>
                    <div class="stat-label">本周测试</div>
                </div>
            </div>
            
            <div class="controls">
                <h3 style="margin-bottom: 15px;">数据筛选与导出</h3>
                <div class="search-filters">
                    <input type="text" id="searchName" placeholder="搜索姓名...">
                    <input type="text" id="searchHolland" placeholder="霍兰德代码 (如: R, RIA)">
                    <select id="searchMBTI">
                        <option value="">选择MBTI类型</option>
                        <option value="INTJ">INTJ</option>
                        <option value="INTP">INTP</option>
                        <option value="ENTJ">ENTJ</option>
                        <option value="ENTP">ENTP</option>
                        <option value="INFJ">INFJ</option>
                        <option value="INFP">INFP</option>
                        <option value="ENFJ">ENFJ</option>
                        <option value="ENFP">ENFP</option>
                        <option value="ISTJ">ISTJ</option>
                        <option value="ISFJ">ISFJ</option>
                        <option value="ESTJ">ESTJ</option>
                        <option value="ESFJ">ESFJ</option>
                        <option value="ISTP">ISTP</option>
                        <option value="ISFP">ISFP</option>
                        <option value="ESTP">ESTP</option>
                        <option value="ESFP">ESFP</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="searchBtn" class="btn btn-small">搜索</button>
                    <button id="resetBtn" class="btn btn-small" style="background: #6c757d;">重置</button>
                    <button id="exportBtn" class="btn btn-small" style="background: #28a745;">导出CSV</button>
                </div>
            </div>
            
            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>完成时间</th>
                            <th>霍兰德代码</th>
                            <th>MBTI类型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="5" class="no-results">暂无数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 初始化（仅使用 anon key）
        const SUPABASE_URL = 'https://axziyvmsdtdcmevcpksd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4eml5dm1zZHRkY21ldmNwa3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MDYyMjAsImV4cCI6MjA3NDI4MjIyMH0.liuWP6Ouc05-K2GCOali-zMk9TKg6h9_abS1-1_LH8Q';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 管理员密码
        const ADMIN_PASSWORD = 'jb82809988';
        
        // 全局数据
        let allResults = [];
        let filteredResults = [];
        
        // 页面元素
        const elements = {
            loginForm: document.getElementById('loginForm'),
            dashboard: document.getElementById('dashboard'),
            password: document.getElementById('password'),
            loginBtn: document.getElementById('loginBtn'),
            loginError: document.getElementById('loginError'),
            totalCount: document.getElementById('totalCount'),
            todayCount: document.getElementById('todayCount'),
            weekCount: document.getElementById('weekCount'),
            searchName: document.getElementById('searchName'),
            searchHolland: document.getElementById('searchHolland'),
            searchMBTI: document.getElementById('searchMBTI'),
            searchBtn: document.getElementById('searchBtn'),
            resetBtn: document.getElementById('resetBtn'),
            exportBtn: document.getElementById('exportBtn'),
            resultsBody: document.getElementById('resultsBody')
        };
        
        // 初始化
        function init() {
            loadData();
            bindEvents();
        }
        
        // 绑定事件
        function bindEvents() {
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.password.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            elements.searchBtn.addEventListener('click', handleSearch);
            elements.resetBtn.addEventListener('click', handleReset);
            elements.exportBtn.addEventListener('click', handleExport);
            
            // 实时搜索
            elements.searchName.addEventListener('input', handleSearch);
            elements.searchHolland.addEventListener('input', handleSearch);
            elements.searchMBTI.addEventListener('change', handleSearch);
        }
        
        // 处理登录
        function handleLogin() {
            const password = elements.password.value;
            if (password === ADMIN_PASSWORD) {
                elements.loginForm.style.display = 'none';
                elements.dashboard.style.display = 'block';
                updateStats();
                displayResults(allResults);
            } else {
                elements.loginError.textContent = '密码错误';
            }
        }
        
        // 加载数据（从 Supabase 拉取）
        async function loadData() {
            try {
                const { data, error } = await supabaseClient
                    .from('test_results')
                    .select('*')
                    .order('timestamp', { ascending: false });
                if (error) {
                    console.error('Supabase 查询失败:', error);
                    allResults = [];
                    filteredResults = [];
                    return;
                }
                allResults = (data || []).map(r => ({
                    name: r.name,
                    timestamp: r.timestamp,
                    holland: r.holland,
                    mbti: r.mbti,
                    hollandAnswers: r.holland_answers,
                    mbtiAnswers: r.mbti_answers
                }));
                filteredResults = [...allResults];
            } catch (e) {
                console.error('网络异常，查询失败:', e);
                allResults = [];
                filteredResults = [];
            }
        }
        
        // 更新统计
        function updateStats() {
            const now = new Date();
            const today = now.toDateString();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const todayResults = allResults.filter(r => new Date(r.timestamp).toDateString() === today);
            const weekResults = allResults.filter(r => new Date(r.timestamp) >= weekAgo);
            
            elements.totalCount.textContent = allResults.length;
            elements.todayCount.textContent = todayResults.length;
            elements.weekCount.textContent = weekResults.length;
        }
        
        // 处理搜索
        function handleSearch() {
            const nameQuery = elements.searchName.value.toLowerCase().trim();
            const hollandQuery = elements.searchHolland.value.toUpperCase().trim();
            const mbtiQuery = elements.searchMBTI.value;
            
            filteredResults = allResults.filter(result => {
                const nameMatch = !nameQuery || result.name.toLowerCase().includes(nameQuery);
                const hollandMatch = !hollandQuery || result.holland.includes(hollandQuery);
                const mbtiMatch = !mbtiQuery || result.mbti === mbtiQuery;
                
                return nameMatch && hollandMatch && mbtiMatch;
            });
            
            displayResults(filteredResults);
        }
        
        // 重置搜索
        function handleReset() {
            elements.searchName.value = '';
            elements.searchHolland.value = '';
            elements.searchMBTI.value = '';
            filteredResults = [...allResults];
            displayResults(filteredResults);
        }
        
        // 显示结果
        function displayResults(results) {
            if (results.length === 0) {
                elements.resultsBody.innerHTML = '<tr><td colspan="5" class="no-results">暂无数据</td></tr>';
                return;
            }
            
            const html = results.map(result => {
                const date = new Date(result.timestamp).toLocaleString('zh-CN');
                return `
                    <tr>
                        <td>${result.name}</td>
                        <td>${date}</td>
                        <td>${result.holland}</td>
                        <td>${result.mbti}</td>
                        <td>
                            <button onclick="viewDetail('${result.timestamp}')" class="btn btn-small" style="background: #17a2b8;">查看详情</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            elements.resultsBody.innerHTML = html;
        }
        
        // 查看详情
        function viewDetail(timestamp) {
            const result = allResults.find(r => r.timestamp === timestamp);
            if (result) {
                const detail = `
姓名: ${result.name}
完成时间: ${new Date(result.timestamp).toLocaleString('zh-CN')}
霍兰德代码: ${result.holland}
MBTI类型: ${result.mbti}

霍兰德答案: ${result.hollandAnswers.join(', ')}
MBTI答案: ${result.mbtiAnswers.join(', ')}
                `;
                alert(detail);
            }
        }
        
        // 导出CSV
        function handleExport() {
            if (filteredResults.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            const headers = ['姓名', '完成时间', '霍兰德代码', 'MBTI类型'];
            const csvContent = [
                headers.join(','),
                ...filteredResults.map(result => [
                    result.name,
                    new Date(result.timestamp).toLocaleString('zh-CN'),
                    result.holland,
                    result.mbti
                ].join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `测评结果_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>