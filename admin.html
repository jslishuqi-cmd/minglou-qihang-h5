<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç®¡ç†å‘˜æ•°æ®çœ‹æ¿ - å¯èˆªåŠ æ²¹ç«™</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .admin-grid{display:grid;grid-template-columns:1fr;gap:12px;}
    .filters{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);}
    th,td{border-bottom:1px solid var(--border);padding:8px;color:var(--text);}
    th{background:#12151b;text-align:left;}
    .count{color:var(--muted);}
  </style>
</head>
<body>
  <section class="page">
    <div class="container" id="login-section">
      <h2>ç®¡ç†å‘˜ç™»å½•</h2>
      <div class="card">
        <label class="label">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </label>
        <input id="admin-password" type="password" class="input" placeholder="è¾“å…¥å¯†ç "/>
        <button id="login-btn" class="btn primary" style="margin-top:12px;">ç™»å½•</button>
      </div>
    </div>
    
    <div class="container" id="admin-panel" style="display:none;">
      <h2>ç®¡ç†å‘˜æ•°æ®çœ‹æ¿</h2>
      <p class="count">æ•°æ®æºä¼˜å…ˆï¼šSupabaseï¼ˆè‹¥å·²åˆå§‹åŒ–ï¼‰ï¼›å¦åˆ™è¯»å–æœ¬åœ°å¤‡ä»½</p>

      <div class="card">
        <div class="filters">
          <div>
            <label class="label">å§“åï¼ˆæ¨¡ç³Šï¼‰</label>
            <input id="filter-name" class="input" placeholder="ä¾‹å¦‚ï¼šå¼  / æ"/>
          </div>
          <div>
            <label class="label">éœå…°å¾·åŒ…å«ï¼ˆå¦‚ R/I/A/S/E/C å¤šé€‰ï¼‰</label>
            <input id="filter-holland" class="input" placeholder="ä¾‹å¦‚ï¼šS æˆ– RE"/>
          </div>
          <div>
            <label class="label">MBTIç²¾ç¡®ï¼ˆå¦‚ INFPï¼‰</label>
            <input id="filter-mbti" class="input" placeholder="ä¾‹å¦‚ï¼šINFP"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="btn-refresh" class="btn">åˆ·æ–°</button>
          <button id="btn-export" class="btn">å¯¼å‡ºExcelï¼ˆCSVï¼‰</button>
        </div>
      </div>

      <div class="card">
        <table id="data-table">
          <thead>
          <tr>
            <th>å§“å</th>
            <th>å®Œæˆæ—¶é—´</th>
            <th>éœå…°å¾·ä»£ç </th>
            <th>MBTIä»£ç </th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- è¯¦ç»†å¾—åˆ†å¼¹çª— -->
  <div id="detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:16px; max-width:700px; width:90%; max-height:80%; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="detail-title">è¯¦ç»†å¾—åˆ†åˆ†æ</h3>
        <button onclick="closeDetailModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- Supabase åˆå§‹åŒ–ï¼šç»Ÿä¸€å¼•ç”¨ SDK ä¸å…¨å±€é…ç½® -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script>
    async function loadData() {
      // ä¼˜å…ˆä» Supabase è¯»å–
      try {
        if (window.supabaseClient) {
          const { data, error } = await window.supabaseClient
            .from('test_results')
            .select('name,timestamp,holland,mbti,holland_answers,mbti_answers')
            .order('timestamp', { ascending: false });
          if (error) throw error;
          console.log('ä» Supabase è¯»å–æˆåŠŸï¼Œæ¡æ•°ï¼š', data.length);
          return data.map(row => ({
            name: row.name || '',
            timestamp: row.timestamp || '',
            holland: row.holland || '',
            mbti: row.mbti || '',
            holland_answers: row.holland_answers || [],
            mbti_answers: row.mbti_answers || []
          }));
        }
      } catch (e) {
        console.error('Supabase è¯»å–å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°ï¼š', e);
      }

      // é€€å›æœ¬åœ°å­˜å‚¨å¤‡ä»½
      try {
        const local = JSON.parse(localStorage.getItem('testResults') || '[]');
        console.log('ä»æœ¬åœ°è¯»å–æˆåŠŸï¼Œæ¡æ•°ï¼š', local.length);
        return local.map(x => ({
          name: x.name || '',
          timestamp: x.timestamp || '',
          holland: x.holland || '',
          mbti: x.mbti || '',
          holland_answers: x.holland_answers || [],
          mbti_answers: x.mbti_answers || []
        })).reverse();
      } catch (_) {
        return [];
      }
    }

    function applyFilters(rows) {
      const nameKey = document.getElementById('filter-name').value.trim();
      const hollandKey = document.getElementById('filter-holland').value.trim().toUpperCase();
      const mbtiKey = document.getElementById('filter-mbti').value.trim().toUpperCase();

      return rows.filter(r => {
        const byName = !nameKey || (r.name || '').includes(nameKey);
        const byHolland = !hollandKey || hollandKey.split('').every(ch => (r.holland || '').includes(ch));
        const byMBTI = !mbtiKey || (r.mbti || '').toUpperCase() === mbtiKey;
        return byName && byHolland && byMBTI;
      });
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.forEach((r, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${formatTime(r.timestamp)}</td>
          <td>${escapeHtml(r.holland)}</td>
          <td>${escapeHtml(r.mbti)}</td>
          <td><button onclick="showDetail(${index})" class="btn" style="padding:4px 8px;font-size:12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;">æŸ¥çœ‹è¯¦æƒ…</button></td>
        `;
        tbody.appendChild(tr);
      });
      // ä¿å­˜å½“å‰æ•°æ®ä¾›è¯¦æƒ…æŸ¥çœ‹ä½¿ç”¨
      window.currentTableData = rows;
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        const d = new Date(ts);
        return d.toLocaleString('zh-CN', { hour12:false });
      } catch { return ts; }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({
        '&':'&','<':'<','>':'>','"':'"',"'":'&#39;'
      }[m]));
    }

    function exportCSV(rows) {
      const header = ['å§“å','å®Œæˆæ—¶é—´','éœå…°å¾·ä»£ç ','MBTIä»£ç '];
      const lines = [header.join(',')].concat(
        rows.map(r => [r.name, formatTime(r.timestamp), r.holland, r.mbti]
          .map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      );
      const blob = new Blob([lines.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'å¯èˆªåŠ æ²¹ç«™_æµ‹è¯•ç»“æœ.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function refresh() {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      renderTable(filtered);
    }

    // äº‹ä»¶
    document.getElementById('btn-refresh').addEventListener('click', refresh);
    document.getElementById('btn-export').addEventListener('click', async () => {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      exportCSV(filtered);
    });
    ['filter-name','filter-holland','filter-mbti'].forEach(id => {
      document.getElementById(id).addEventListener('input', refresh);
    });

    // ç™»å½•éªŒè¯
    const ADMIN_PASSWORD = '82809988';
    document.getElementById('login-btn').addEventListener('click', () => {
      const password = document.getElementById('admin-password').value;
      if (password === ADMIN_PASSWORD) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        refresh();
      } else {
        alert('å¯†ç é”™è¯¯');
        document.getElementById('admin-password').value = '';
      }
    });
    
    // å›è½¦ç™»å½•
    document.getElementById('admin-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('login-btn').click();
      }
    });

    // è¯¦ç»†å¾—åˆ†åˆ†æåŠŸèƒ½
    let allData = [];

    async function showDetail(index) {
      const user = window.currentTableData ? window.currentTableData[index] : null;
      if (!user) {
        alert('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„è¯¦ç»†æ•°æ®');
        return;
      }

      document.getElementById('detail-title').textContent = `${name} - è¯¦ç»†å¾—åˆ†åˆ†æ`;
      
      let content = '<div style="line-height:1.6;">';
      
      // éœå…°å¾·è¯¦ç»†å¾—åˆ†
      content += '<h4 style="color:#3b82f6; margin-bottom:15px;">ğŸ¯ éœå…°å¾·èŒä¸šå…´è¶£è¯¦ç»†å¾—åˆ†</h4>';
      if (user.holland_answers && user.holland_answers.length > 0) {
        const hollandScores = calculateHollandScores(user.holland_answers);
        content += '<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:20px;">';
        Object.entries(hollandScores).forEach(([type, score]) => {
          const typeNames = {
            'R': 'ç°å®å‹(Realistic)',
            'I': 'ç ”ç©¶å‹(Investigative)', 
            'A': 'è‰ºæœ¯å‹(Artistic)',
            'S': 'ç¤¾ä¼šå‹(Social)',
            'E': 'ä¼ä¸šå‹(Enterprising)',
            'C': 'å¸¸è§„å‹(Conventional)'
          };
          const percentage = Math.round((score / 10) * 100);
          content += `
            <div style="background:#f8fafc; padding:12px; border-radius:8px; border-left:4px solid #3b82f6;">
              <div style="font-weight:bold; color:#1e293b;">${type} - ${typeNames[type]}</div>
              <div style="color:#64748b; font-size:14px;">${score}/10 åˆ† (${percentage}%)</div>
              <div style="background:#e2e8f0; height:6px; border-radius:3px; margin-top:5px;">
                <div style="background:#3b82f6; height:100%; width:${percentage}%; border-radius:3px;"></div>
              </div>
            </div>
          `;
        });
        content += '</div>';
      } else {
        content += '<p style="color:#64748b;">æš‚æ— éœå…°å¾·ç­”é¢˜è¯¦æƒ…</p>';
      }

      // MBTIè¯¦ç»†å¾—åˆ†
      content += '<h4 style="color:#8b5cf6; margin-bottom:15px;">ğŸ§  MBTIæ€§æ ¼åå¥½è¯¦ç»†åˆ†æ</h4>';
      if (user.mbti_answers && user.mbti_answers.length > 0) {
        const mbtiScores = calculateMBTIScores(user.mbti_answers);
        content += '<div style="display:grid; grid-template-columns:1fr; gap:15px;">';
        
        const dimensions = [
          { key: 'EI', name: 'å¤–å‘(E) vs å†…å‘(I)', left: 'E', right: 'I' },
          { key: 'SN', name: 'æ„Ÿè§‰(S) vs ç›´è§‰(N)', left: 'S', right: 'N' },
          { key: 'TF', name: 'æ€è€ƒ(T) vs æƒ…æ„Ÿ(F)', left: 'T', right: 'F' },
          { key: 'JP', name: 'åˆ¤æ–­(J) vs çŸ¥è§‰(P)', left: 'J', right: 'P' }
        ];

        dimensions.forEach(dim => {
          const leftScore = mbtiScores[dim.left] || 0;
          const rightScore = mbtiScores[dim.right] || 0;
          const total = leftScore + rightScore;
          const leftPercent = total > 0 ? Math.round((leftScore / total) * 100) : 50;
          const rightPercent = 100 - leftPercent;
          const dominant = leftPercent > rightPercent ? dim.left : dim.right;
          const dominantPercent = Math.max(leftPercent, rightPercent);

          content += `
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid #8b5cf6;">
              <div style="font-weight:bold; color:#1e293b; margin-bottom:8px;">${dim.name}</div>
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="color:#64748b;">${dim.left}: ${leftScore}é¢˜ (${leftPercent}%)</span>
                <span style="color:#64748b;">${dim.right}: ${rightScore}é¢˜ (${rightPercent}%)</span>
              </div>
              <div style="display:flex; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                <div style="background:#8b5cf6; width:${leftPercent}%;"></div>
                <div style="background:#06b6d4; width:${rightPercent}%;"></div>
              </div>
              <div style="text-align:center; margin-top:8px; font-weight:bold; color:#${dominant === dim.left ? '8b5cf6' : '06b6d4'};">
                å€¾å‘ï¼š${dominant} (${dominantPercent}%)
              </div>
            </div>
          `;
        });
        content += '</div>';
      } else {
        content += '<p style="color:#64748b;">æš‚æ— MBTIç­”é¢˜è¯¦æƒ…</p>';
      }

      // ç»¼åˆç»“æœ
      content += `
        <div style="margin-top:25px; padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; color:white;">
          <h4 style="margin:0 0 10px 0;">ğŸ“Š ç»¼åˆæµ‹è¯„ç»“æœ</h4>
          <div style="display:flex; justify-content:space-around; text-align:center;">
            <div>
              <div style="font-size:24px; font-weight:bold;">${user.holland}</div>
              <div style="opacity:0.9;">éœå…°å¾·ä»£ç </div>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.3);"></div>
            <div>
              <div style="font-size:24px; font-weight:bold;">${user.mbti}</div>
              <div style="opacity:0.9;">MBTIç±»å‹</div>
            </div>
          </div>
        </div>
      `;

      content += '</div>';
      document.getElementById('detail-content').innerHTML = content;
      document.getElementById('detail-modal').style.display = 'block';
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').style.display = 'none';
    }

    function calculateHollandScores(answers) {
      const scores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
      const hollandMapping = [
        'R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I',
        'A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S',
        'E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C'
      ];
      
      answers.forEach((answer, index) => {
        if (answer && hollandMapping[index]) {
          scores[hollandMapping[index]]++;
        }
      });
      
      return scores;
    }

    function calculateMBTIScores(answers) {
      const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
      const mbtiMapping = [
        'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
        'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P',
        'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
        'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P',
        'E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N',
        'T','F','J','P','E','I','S','N','T','F','J','P','E','I','S','N','T','F','J','P'
      ];
      
      answers.forEach((answer, index) => {
        if (answer && mbtiMapping[index]) {
          scores[mbtiMapping[index]]++;
        }
      });
      
      return scores;
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') {
        closeDetailModal();
      }
    });
  </script>
</body>
</html>