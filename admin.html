<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>管理员数据看板 - 启航加油站</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .admin-grid{display:grid;grid-template-columns:1fr;gap:12px;}
    .filters{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);}
    th,td{border-bottom:1px solid var(--border);padding:8px;color:var(--text);}
    th{background:#2d3748;color:#ffffff;text-align:left;font-weight:600;}
    .count{color:var(--muted);}
    .delete-btn{background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;margin-left:8px;}
    .delete-btn:hover{background:#dc2626;}
    .batch-actions{margin-top:12px;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;}
    .checkbox{margin-right:8px;}
  </style>
</head>
<body>
  <section class="page">
    <div class="container" id="login-section">
      <h2>管理员登录</h2>
      <div class="card">
        <label class="label">请输入管理员密码</label>
        <input id="admin-password" type="password" class="input" placeholder="输入密码"/>
        <button id="login-btn" class="btn primary" style="margin-top:12px;">登录</button>
      </div>
    </div>
    
    <div class="container" id="admin-panel" style="display:none;">
      <h2>管理员数据看板</h2>
      <p class="count">数据源：Supabase 云端数据库</p>

      <div class="card">
        <div class="filters">
          <div>
            <label class="label">姓名（模糊）</label>
            <input id="filter-name" class="input" placeholder="例如：张 / 李"/>
          </div>
          <div>
            <label class="label">霍兰德包含（如 R/I/A/S/E/C 多选）</label>
            <input id="filter-holland" class="input" placeholder="例如：S 或 RE"/>
          </div>
          <div>
            <label class="label">MBTI精确（如 INFP）</label>
            <input id="filter-mbti" class="input" placeholder="例如：INFP"/>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="btn-refresh" class="btn">刷新</button>
          <button id="btn-export" class="btn">导出Excel（CSV）</button>
        </div>
        
        <div class="batch-actions" style="display:none;" id="batch-actions">
          <div style="display:flex;align-items:center;gap:12px;">
            <span>已选择 <span id="selected-count">0</span> 条记录</span>
            <button id="btn-delete-selected" class="delete-btn">删除选中</button>
            <button id="btn-select-all" class="btn" style="font-size:12px;">全选</button>
            <button id="btn-clear-selection" class="btn" style="font-size:12px;">取消选择</button>
          </div>
        </div>
      </div>

      <div class="card">
        <table id="data-table">
          <thead>
          <tr>
            <th><input type="checkbox" id="select-all-checkbox" class="checkbox"> 姓名</th>
            <th>完成时间</th>
            <th>霍兰德代码</th>
            <th>MBTI代码</th>
            <th style="width:180px;">操作</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 详细得分弹窗 -->
  <div id="detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:16px; max-width:700px; width:90%; max-height:80%; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="detail-title">详细得分分析</h3>
        <button onclick="closeDetailModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- Supabase 初始化：统一引用 SDK 与全局配置 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script>
    async function loadData() {
      try {
        if (window.supabaseClient) {
          const { data, error } = await window.supabaseClient
            .from('test_results')
            .select('name,timestamp,holland,mbti,holland_answers,mbti_answers')
            .order('timestamp', { ascending: false });
          if (error) throw error;
          console.log('从 Supabase 读取成功，条数：', data.length);
          return data.map(row => ({
            name: row.name || '',
            timestamp: row.timestamp || '',
            holland: row.holland || '',
            mbti: row.mbti || '',
            holland_answers: row.holland_answers || [],
            mbti_answers: row.mbti_answers || []
          }));
        } else {
          console.error('Supabase 未初始化');
          alert('云端服务未连接，请刷新页面重试');
          return [];
        }
      } catch (e) {
        console.error('Supabase 读取失败：', e);
        alert('数据加载失败：' + e.message);
        return [];
      }
    }

    function applyFilters(rows) {
      const nameKey = document.getElementById('filter-name').value.trim();
      const hollandKey = document.getElementById('filter-holland').value.trim().toUpperCase();
      const mbtiKey = document.getElementById('filter-mbti').value.trim().toUpperCase();

      return rows.filter(r => {
        const byName = !nameKey || (r.name || '').includes(nameKey);
        const byHolland = !hollandKey || hollandKey.split('').every(ch => (r.holland || '').includes(ch));
        const byMBTI = !mbtiKey || (r.mbti || '').toUpperCase() === mbtiKey;
        return byName && byHolland && byMBTI;
      });
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.forEach((r, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="row-checkbox checkbox" data-index="${index}" data-name="${escapeHtml(r.name)}" data-timestamp="${r.timestamp}"> ${escapeHtml(r.name)}</td>
          <td>${formatTime(r.timestamp)}</td>
          <td>${escapeHtml(r.holland)}</td>
          <td>${escapeHtml(r.mbti)}</td>
          <td>
            <button onclick="showDetail(${index})" style="padding:6px 12px;font-size:12px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">查看详情</button>
            <button onclick="deleteRecord(${index})" class="delete-btn">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // 保存当前数据供详情查看使用
      window.currentTableData = rows;
      console.log('表格已渲染，行数：', rows.length);
      updateBatchActions();
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        const d = new Date(ts);
        return d.toLocaleString('zh-CN', { hour12:false });
      } catch { return ts; }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({
        '&':'&','<':'<','>':'>','"':'"',"'":'&#39;'
      }[m]));
    }

    function exportCSV(rows) {
      const header = ['姓名','完成时间','霍兰德代码','MBTI代码'];
      const lines = [header.join(',')].concat(
        rows.map(r => [r.name, formatTime(r.timestamp), r.holland, r.mbti]
          .map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      );
      const blob = new Blob([lines.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '启航加油站_测试结果.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function refresh() {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      renderTable(filtered);
    }

    // 事件
    document.getElementById('btn-refresh').addEventListener('click', refresh);
    document.getElementById('btn-export').addEventListener('click', async () => {
      const rows = await loadData();
      const filtered = applyFilters(rows);
      exportCSV(filtered);
    });
    ['filter-name','filter-holland','filter-mbti'].forEach(id => {
      document.getElementById(id).addEventListener('input', refresh);
    });

    // 登录验证
    const ADMIN_PASSWORD = '82809988';
    document.getElementById('login-btn').addEventListener('click', () => {
      const password = document.getElementById('admin-password').value;
      if (password === ADMIN_PASSWORD) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        refresh();
      } else {
        alert('密码错误');
        document.getElementById('admin-password').value = '';
      }
    });
    
    // 回车登录
    document.getElementById('admin-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('login-btn').click();
      }
    });

    // 详细得分分析功能
    let allData = [];

    async function showDetail(index) {
      const user = window.currentTableData ? window.currentTableData[index] : null;
      if (!user) {
        alert('未找到该用户的详细数据');
        return;
      }

      document.getElementById('detail-title').textContent = `${name} - 详细得分分析`;
      
      let content = '<div style="line-height:1.6;">';
      
      // 霍兰德详细得分
      content += '<h4 style="color:#3b82f6; margin-bottom:15px;">🎯 霍兰德职业兴趣详细得分</h4>';
      if (user.holland_answers && user.holland_answers.length > 0) {
        const hollandScores = calculateHollandScores(user.holland_answers);
        content += '<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:20px;">';
        Object.entries(hollandScores).forEach(([type, score]) => {
          const typeNames = {
            'R': '现实型(Realistic)',
            'I': '研究型(Investigative)', 
            'A': '艺术型(Artistic)',
            'S': '社会型(Social)',
            'E': '企业型(Enterprising)',
            'C': '常规型(Conventional)'
          };
          const percentage = Math.round((score / 10) * 100);
          content += `
            <div style="background:#f8fafc; padding:12px; border-radius:8px; border-left:4px solid #3b82f6;">
              <div style="font-weight:bold; color:#1e293b;">${type} - ${typeNames[type]}</div>
              <div style="color:#64748b; font-size:14px;">${score}/10 分 (${percentage}%)</div>
              <div style="background:#e2e8f0; height:6px; border-radius:3px; margin-top:5px;">
                <div style="background:#3b82f6; height:100%; width:${percentage}%; border-radius:3px;"></div>
              </div>
            </div>
          `;
        });
        content += '</div>';
      } else {
        content += '<p style="color:#64748b;">暂无霍兰德答题详情</p>';
      }

      // MBTI详细得分
      content += '<h4 style="color:#8b5cf6; margin-bottom:15px;">🧠 MBTI性格偏好详细分析</h4>';
      if (user.mbti_answers && user.mbti_answers.length > 0) {
        const mbtiScores = calculateMBTIScores(user.mbti_answers);
        content += '<div style="display:grid; grid-template-columns:1fr; gap:15px;">';
        
        const dimensions = [
          { key: 'EI', name: '外向(E) vs 内向(I)', left: 'E', right: 'I' },
          { key: 'SN', name: '感觉(S) vs 直觉(N)', left: 'S', right: 'N' },
          { key: 'TF', name: '思考(T) vs 情感(F)', left: 'T', right: 'F' },
          { key: 'JP', name: '判断(J) vs 知觉(P)', left: 'J', right: 'P' }
        ];

        dimensions.forEach(dim => {
          const leftScore = mbtiScores[dim.left] || 0;
          const rightScore = mbtiScores[dim.right] || 0;
          const total = leftScore + rightScore;
          const leftPercent = total > 0 ? Math.round((leftScore / total) * 100) : 50;
          const rightPercent = 100 - leftPercent;
          const dominant = leftPercent > rightPercent ? dim.left : dim.right;
          const dominantPercent = Math.max(leftPercent, rightPercent);

          content += `
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid #8b5cf6;">
              <div style="font-weight:bold; color:#1e293b; margin-bottom:8px;">${dim.name}</div>
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="color:#64748b;">${dim.left}: ${leftScore}题 (${leftPercent}%)</span>
                <span style="color:#64748b;">${dim.right}: ${rightScore}题 (${rightPercent}%)</span>
              </div>
              <div style="display:flex; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                <div style="background:#8b5cf6; width:${leftPercent}%;"></div>
                <div style="background:#06b6d4; width:${rightPercent}%;"></div>
              </div>
              <div style="text-align:center; margin-top:8px; font-weight:bold; color:#${dominant === dim.left ? '8b5cf6' : '06b6d4'};">
                倾向：${dominant} (${dominantPercent}%)
              </div>
            </div>
          `;
        });
        content += '</div>';
      } else {
        content += '<p style="color:#64748b;">暂无MBTI答题详情</p>';
      }

      // 综合结果
      content += `
        <div style="margin-top:25px; padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; color:white;">
          <h4 style="margin:0 0 10px 0;">📊 综合测评结果</h4>
          <div style="display:flex; justify-content:space-around; text-align:center;">
            <div>
              <div style="font-size:24px; font-weight:bold;">${user.holland}</div>
              <div style="opacity:0.9;">霍兰德代码</div>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.3);"></div>
            <div>
              <div style="font-size:24px; font-weight:bold;">${user.mbti}</div>
              <div style="opacity:0.9;">MBTI类型</div>
            </div>
          </div>
        </div>
      `;

      content += '</div>';
      document.getElementById('detail-content').innerHTML = content;
      document.getElementById('detail-modal').style.display = 'block';
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').style.display = 'none';
    }

    function calculateHollandScores(answers) {
      const scores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
      const hollandMapping = [
        'R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I',
        'A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S',
        'E','C','R','I','A','S','E','C','R','I','A','S','E','C','R','I','A','S','E','C'
      ];
      
      answers.forEach((answer, index) => {
        if (answer && hollandMapping[index]) {
          scores[hollandMapping[index]]++;
        }
      });
      
      console.log('MBTI计算结果:', scores);
      return scores;
    }

    function calculateMBTIScores(answers) {
      const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
      
      if (!answers || !Array.isArray(answers)) {
        console.warn('MBTI答题数据无效:', answers);
        return scores;
      }
      
      console.log('MBTI答题数据长度:', answers.length, '前10个答案:', answers.slice(0, 10));
      
      // MBTI 100题分为4个维度，每个维度25题
      // 第1-25题：E vs I (外向 vs 内向) - A选项=E，B选项=I
      // 第26-50题：S vs N (感觉 vs 直觉) - A选项=S，B选项=N
      // 第51-75题：T vs F (思考 vs 情感) - A选项=T，B选项=F
      // 第76-100题：J vs P (判断 vs 知觉) - A选项=J，B选项=P
      
      answers.forEach((answer, index) => {
        if (!answer || (answer !== 'A' && answer !== 'B')) {
        return; // 跳过无效答案
      }
        
        if (index < 25) {
          // 第1-25题：E vs I
          if (answer === 'A') {
            scores.E++;
          } else if (answer === 'B') {
            scores.I++;
          }
        } else if (index < 50) {
          // 第26-50题：S vs N
          if (answer === 'A') {
            scores.S++;
          } else if (answer === 'B') {
            scores.N++;
          }
        } else if (index < 75) {
          // 第51-75题：T vs F
          if (answer === 'A') {
            scores.T++;
          } else if (answer === 'B') {
            scores.F++;
          }
        } else if (index < 100) {
          // 第76-100题：J vs P
          if (answer === 'A') {
            scores.J++;
          } else if (answer === 'B') {
            scores.P++;
          }
        }
      });
      
      return scores;
    }

    // 删除功能
    async function deleteRecord(index) {
      const user = window.currentTableData[index];
      if (!user) {
        alert('未找到要删除的记录');
        return;
      }
      
      if (!confirm(`确定要删除 "${user.name}" 的测试记录吗？此操作不可恢复！`)) {
        return;
      }
      
      try {
        if (window.supabaseClient) {
          const { error } = await window.supabaseClient
            .from('test_results')
            .delete()
            .eq('name', user.name)
            .eq('timestamp', user.timestamp);
          
          if (error) throw error;
          console.log('从 Supabase 删除成功');
          alert('删除成功！');
          refresh();
        } else {
          alert('云端服务未连接，无法删除');
        }
      } catch (error) {
        console.error('删除失败：', error);
        alert('删除失败：' + error.message);
      }
    }
    
    async function deleteSelectedRecords() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('请先选择要删除的记录');
        return;
      }
      
      if (!confirm(`确定要删除选中的 ${checkboxes.length} 条记录吗？此操作不可恢复！`)) {
        return;
      }
      
      try {
        const recordsToDelete = Array.from(checkboxes).map(cb => ({
          name: cb.dataset.name,
          timestamp: cb.dataset.timestamp
        }));
        
        if (window.supabaseClient) {
          for (const record of recordsToDelete) {
            const { error } = await window.supabaseClient
              .from('test_results')
              .delete()
              .eq('name', record.name)
              .eq('timestamp', record.timestamp);
            
            if (error) throw error;
          }
          console.log('从 Supabase 批量删除成功');
          alert(`成功删除 ${recordsToDelete.length} 条记录！`);
          refresh();
        } else {
          alert('云端服务未连接，无法删除');
        }
      } catch (error) {
        console.error('批量删除失败：', error);
        alert('批量删除失败：' + error.message);
      }
    }
    
    function updateBatchActions() {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      const batchActions = document.getElementById('batch-actions');
      const selectedCount = document.getElementById('selected-count');
      
      if (checkedBoxes.length > 0) {
        batchActions.style.display = 'block';
        selectedCount.textContent = checkedBoxes.length;
      } else {
        batchActions.style.display = 'none';
      }
      
      // 更新全选复选框状态
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      if (checkboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      } else if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
      } else if (checkedBoxes.length > 0) {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
      } else {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      }
    }
    
    // 批量操作事件监听
    document.getElementById('btn-delete-selected').addEventListener('click', deleteSelectedRecords);
    
    document.getElementById('btn-select-all').addEventListener('click', () => {
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = true);
      updateBatchActions();
    });
    
    document.getElementById('btn-clear-selection').addEventListener('click', () => {
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
      updateBatchActions();
    });
    
    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
      updateBatchActions();
    });
    
    // 监听行复选框变化
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('row-checkbox')) {
        updateBatchActions();
      }
    });

    // 点击弹窗外部关闭
    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') {
        closeDetailModal();
      }
    });
  </script>
</body>
</html>